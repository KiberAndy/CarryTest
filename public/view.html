<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты теста на совместимость игроков</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #ffffff;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e2e;
        }
        
        h1, h2 {
            color: #ffffff;
            text-align: center;
        }
        
        .profile-section {
            background-color: #2a2a3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .progress-container {
            width: 100%;
            background-color: #444;
            border-radius: 10px;
            margin: 20px 0;
            height: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            width: 0%;
            transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            right: 10px;
            color: white;
            font-weight: bold;
            z-index: 2;
        }
        
        .compatibility-level {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #28a745;
            text-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
            animation: pulse 2s infinite;
        }
        
        .trait {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .trait-name {
            font-weight: bold;
            width: 40%;
        }
        
        .trait-bar {
            width: 55%;
            height: 15px;
            background-color: #444;
            border-radius: 7px;
            position: relative;
            overflow: hidden;
        }
        
        .trait-fill {
            height: 100%;
            border-radius: 7px;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            width: 0%;
            transition: width 0.8s ease-out;
        }
        
        .trait-percent {
            position: absolute;
            right: 5px;
            font-size: 11px;
            color: white;
            z-index: 2;
        }
        
        .loading {
            text-align: center;
            font-size: 18px;
            margin: 50px 0;
        }
        
        .error {
            color: #dc3545;
            text-align: center;
            margin: 50px 0;
        }
        
        .date {
            text-align: right;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        ol {
            padding-left: 20px;
        }
        
        li {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }
        
        li:last-child {
            border-bottom: none;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #666;
            cursor: help;
            color: #ffcc00;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        @keyframes pulse {
            0% { text-shadow: 0 0 10px rgba(40, 167, 69, 0.5); }
            50% { text-shadow: 0 0 20px rgba(40, 167, 69, 0.8); }
            100% { text-shadow: 0 0 10px rgba(40, 167, 69, 0.5); }
        }
    </style>
	
<!-- Favicon -->
<link rel="icon" href="/favicon/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon/favicon.ico">

<!-- Для современных браузеров -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="icon" type="image/svg+xml" sizes="any" href="/favicon/favicon.svg">

<!-- Для iOS/Safari -->
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">



<!-- Цвета для мобильных браузеров -->
<meta name="theme-color" content="#1e1e2e">
<meta name="msapplication-TileColor" content="#1e1e2e">

<!-- Указание авторства (если используете иконки Flaticon) -->
<div class="credits">
  <span class="credits__text">Иконки от</span>
  <a href="https://www.flaticon.com/authors/freepik" 
     class="credits__link"
     target="_blank" 
     rel="noopener"
     title="Freepik">
    <svg class="credits__icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
    </svg>
    Freepik
  </a>
  <span class="credits__divider">|</span>
  <a href="https://www.flaticon.com" 
     class="credits__link"
     target="_blank" 
     rel="noopener"
     title="Flaticon">
    <svg class="credits__icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 8v8m-4-4h8"/>
    </svg>
    Flaticon
  </a>
</div>

<style>
.credits {
  position: fixed;
  top: 16px;        /* Изменили с bottom на top */
  left: 16px;       /* Изменили с right на left */
  display: flex;
  align-items: center;
  gap: 4px;         /* Уменьшили промежуток между элементами */
  font-family: 'Segoe UI', -apple-system, sans-serif;
  font-size: 12px;   /* Уменьшили размер текста */
  line-height: 1;
  padding: 6px 10px; /* Слегка уменьшили отступы */
  background: rgba(30, 30, 30, 0.7);
  backdrop-filter: blur(4px);
  border-radius: 18px; /* Чуть меньше скругление */
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  color: rgba(255, 255, 255, 0.7);
  transition: all 0.3s ease;
}

/* Остальные стили оставляем без изменений */
.credits:hover {
  background: rgba(40, 40, 40, 0.9);
  color: rgba(255, 255, 255, 0.9);
  border-color: rgba(255, 255, 255, 0.15);
}

.credits__text {
  font-weight: 400;
}

.credits__link {
  display: flex;
  align-items: center;
  gap: 4px;
  color: inherit;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s ease;
}

.credits__link:hover {
  color: #58a6ff;
}

.credits__icon {
  flex-shrink: 0;
  stroke-width: 2;
}

.credits__divider {
  opacity: 0.3;
  margin: 0 2px;
}

.credits__icon {
  transition: transform 0.3s ease, stroke 0.3s ease;
}

.credits__link:hover .credits__icon {
  transform: scale(1.1);
  stroke: #58a6ff;
}
</style>
	
</head>
<body>
    <h1>Результаты теста на совместимость игроков</h1>
    
    <div id="loading" class="loading">
        Загрузка результатов...
    </div>
    
    <div id="error" class="error" style="display: none;">
        Не удалось загрузить результаты. Проверьте правильность ссылки.
    </div>
    
    <div id="result" style="display: none;">
        <div class="date" id="result-date"></div>
        
        <div class="profile-section">
            <h2>Профиль игрока</h2>
            
            <div class="compatibility-level" id="compatibility-level"></div>
            
            <div class="progress-container">
                <div class="progress-bar" id="compatibility-bar"></div>
                <span class="progress-text" id="progress-text">0%</span>
            </div>
        </div>
        
        <div class="profile-section">
            <h3>Характеристики:</h3>
            <div id="traits-container"></div>
        </div>
        
        <div class="profile-section">
            <h3>Описание профиля:</h3>
            <p id="profile-description"></p>
        </div>
        
        <div class="profile-section">
            <h3>Советы по взаимодействию:</h3>
            <p id="interaction-tips"></p>
        </div>
        
        <div class="profile-section" id="answers-section">
            <h3>Ответы:</h3>
            <ol id="answers-list"></ol>
        </div>
    </div>

    <script>
        // Получаем токен из URL
        const urlParams = new URLSearchParams(window.location.search);
        const shareToken = urlParams.get('share') || urlParams.get('result');
        
        // Вопросы теста (должны соответствовать вопросам в index.html)
        const questions = [
            {
                question: "Как ты реагируешь на проигрыш?",
                options: [
                    "Спокойно анализирую ошибки",
                    "Лёгкое недовольство",
                    "Сильно расстраиваюсь",
                    "Злюсь и обвиняю команду"
                ]
            },
            {
                question: "Ты предпочитаешь играть:",
                options: [
                    "Всегда на команду",
                    "В основном на команду",
                    "Чаще на себя",
                    "Только на себя"
                ]
            },
            {
                question: "Как часто ты общаешься в голосовом чате?",
                options: [
                    "Очень активно",
                    "В меру",
                    "Редко",
                    "Вообще не общаюсь"
                ]
            },
            {
                question: "Как ты относишься к ошибкам напарников?",
                options: [
                    "Спокойно, все ошибаются",
                    "Могу сделать замечание",
                    "Злюсь, но молчу",
                    "Ругаюсь и обвиняю"
                ]
            },
            {
                question: "Как ты обучаешься в играх?",
                options: [
                    "Быстро разбираюсь и использую на практике",
                    "Учусь, но не сразу",
                    "Долго адаптируюсь",
                    "Не хочу учиться"
                ]
            },
            {
                question: "Какую роль в команде предпочитаешь?",
                options: [
                    "Поддержка (помогаю команде)",
                    "Лидер (организую игру)",
                    "Атакующий (иду на прорыв)",
                    "Одиночка (играю сам по себе)"
                ]
            },
            {
                question: "Как долго ты можешь играть без перерыва?",
                options: [
                    "Очень долго (5+ часов)",
                    "Долго (3-4 часа)",
                    "Не очень долго (1-2 часа)",
                    "Быстро устаю (менее часа)"
                ]
            },
            {
                question: "Как ты реагируешь на <span class='tooltip'>токсичных игроков<span class='tooltiptext'>Грубят, оскорбляют, намеренно мешают игре</span></span>?",
                options: [
                    "Игнорирую",
                    "Отвечаю спокойно",
                    "Начинаю спорить",
                    "Разжигаю конфликт"
                ]
            },
            {
                question: "Как ты относишься к <span class='tooltip'>игре по стратегии<span class='tooltiptext'>Когда команда заранее планирует тактику и строго её придерживается</span></span>?",
                options: [
                    "Обожаю чёткие планы",
                    "Нравится, но не всегда",
                    "Мешает импровизации",
                    "Вообще не люблю тактики"
                ]
            },
            {
                question: "Как ведёшь себя в <span class='tooltip'>критических<span class='tooltiptext'>Сложных, напряжённых моментах игры (например, когда команда проигрывает или остаётся в меньшинстве)</span></span> ситуациях?",
                options: [
                    "Собран и хладнокровен",
                    "Слегка нервничаю",
                    "Паникую",
                    "Бросаю игру"
                ]
            },
            {
                question: "Как ты относишься к новичкам в команде?",
                options: [
                    "Помогаю и объясняю",
                    "Терплю, но с замечаниями",
                    "Игнорирую",
                    "Раздражаюсь"
                ]
            },
            {
                question: "Как ты выбираешь героя/класс?",
                options: [
                    "Выбираю по нуждам команды",
                    "Выбираю любимого героя",
                    "Беру того, кто сильнее",
                    "Всегда играю одной ролью"
                ]
            },
            {
                question: "Что делаешь после нескольких поражений подряд?",
                options: [
                    "Продолжаю играть спокойно",
                    "Разбираю ошибки",
                    "Злюсь, но играю",
                    "Бросаю игру"
                ]
            },
            {
                question: "Как ты играешь с <span class='tooltip'>незнакомцами<span class='tooltiptext'>Случайные игроки в твоей команде (не друзья)</span></span>?",
                options: [
                    "Легко нахожу общий язык",
                    "Пробую сотрудничать",
                    "Не доверяю",
                    "Раздражают"
                ]
            },
            {
                question: "Как реагируешь на игру против более сильных соперников?",
                options: [
                    "Вызов! Это интересно!",
                    "Немного напрягаюсь, но стараюсь",
                    "Чувлю раздражение",
                    "Быстро сдаюсь"
                ]
            },
            {
                question: "Как относишься к читерам?",
                options: [
                    "Жалуюсь и блокирую",
                    "Игнорирую",
                    "Пробую адаптироваться",
                    "Читерю в ответ"
                ]
            },
            {
                question: "Как ведёшь себя в споре с командой?",
                options: [
                    "Обсуждаю аргументированно",
                    "Могу вспылить, но быстро остываю",
                    "Часто спорю",
                    "Настаиваю на своём и злюсь"
                ]
            },
            {
                question: "Насколько ты <span class='tooltip'>чувствительный<span class='tooltiptext'>Как сильно ты эмоционально реагируешь на критику, троллинг или неудачи в игре</span></span>?",
                options: [
                    "Очень спокойный, меня сложно вывести из себя",
                    "В основном спокоен, но иногда могу расстроиться",
                    "Довольно эмоциональный, часто переживаю из-за игры",
                    "Чрезвычайно чувствительный, любая критика сильно задевает"
                ]
            },
            {
                question: "Что для тебя важнее в игре?",
                options: [
                    "Командная победа",
                    "Личный успех",
                    "Приятное времяпрепровождение",
                    "Оценки и рейтинги"
                ]
            },
            {
                question: "Часто ли ты отвлекаешься во время игры?",
                options: [
                    "Редко, полностью сосредоточен",
                    "Иногда, но не мешает игре",
                    "Часто, теряю концентрацию",
                    "Постоянно отвлекаюсь"
                ]
            }
        ];

  // Инициализация Supabase
  async function initSupabase() {
    try {
      // Подключаем Supabase
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');

      // Загружаем конфиг из Netlify Function
      const response = await fetch('/.netlify/functions/saveResults');
      if (!response.ok) throw new Error('Не удалось загрузить конфиг');

      const env = await response.json();
      if (!env.SUPABASE_URL || !env.SUPABASE_KEY) {
        throw new Error('Не настроены переменные Supabase');
      }

      // Инициализация Supabase
      window.supabase = createClient(env.SUPABASE_URL, env.SUPABASE_KEY);

      console.log('Supabase инициализирован');
      return true;
    } catch (error) {
      console.error('Ошибка инициализации Supabase:', error);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Ошибка загрузки данных. Попробуйте позже.';
      return false;
    }
  }

  // Проверяем токен и загружаем результаты
  async function checkAndLoadResults() {
    if (!shareToken) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Ссылка на результаты недействительна (отсутствует токен)';
      return;
    }

    const supabaseReady = await initSupabase();
    if (!supabaseReady) return;

    try {
      // Ищем результаты по токену
      const { data, error } = await supabase
        .from('test_results')
        .select('*')
        .eq('share_token', shareToken)
        .single();

      if (error || !data) throw error || new Error('Результаты не найдены');

      console.log('Результаты загружены:', data);
      displayResults(data);

    } catch (error) {
      console.error('Ошибка загрузки результатов:', error);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'Не удалось загрузить результаты. Ссылка может быть недействительна.';
    }
  }

  // Вызов функции загрузки
  checkAndLoadResults();


        
        // Отображаем результаты
        function displayResults(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            
            // Устанавливаем дату
            const date = new Date(data.created_at || new Date());
            document.getElementById('result-date').textContent = 
                `${date.toLocaleDateString()}, ${date.toLocaleTimeString()}`;
            
            const scores = data.scores;
            const answers = data.answers;
            
            // Рассчитываем общую совместимость
            const keyTraits = ['temperament', 'tolerance', 'communication', 'teamSpirit', 'humor'];
            const totalScore = keyTraits.reduce((sum, trait) => sum + (scores[trait] || 0), 0) / keyTraits.length;
            const roundedScore = Math.round(totalScore);
            
            // Устанавливаем прогресс
            const compatibilityBar = document.getElementById('compatibility-bar');
            compatibilityBar.style.width = `${roundedScore}%`;
            document.getElementById('progress-text').textContent = `${roundedScore}%`;
            
            // Изменяем цвет прогресс-бара
            if (roundedScore <= 33) {
                compatibilityBar.style.background = 'linear-gradient(90deg, #dc3545, #dc3545)';
            } else if (roundedScore <= 66) {
                compatibilityBar.style.background = 'linear-gradient(90deg, #dc3545, #ffc107)';
            } else {
                compatibilityBar.style.background = 'linear-gradient(90deg, #dc3545, #ffc107, #28a745)';
            }
            
            // Устанавливаем текстовое описание совместимости
            let compatibilityText, description, levelColor;
            
            if (roundedScore >= 90) {
                compatibilityText = "Лучший друг по играм";
                description = "Этот игрок - идеальный командный игрок, с которым приятно и продуктивно играть. Его напарники ценят его за позитивный настрой, готовность помочь и стремление к победе.";
                levelColor = "#28a745";
            } else if (roundedScore >= 75) {
                compatibilityText = "Идеальный напарник";
                description = "Этот игрок - отличный командный игрок, с которым большинству будет комфортно играть. Его сильные стороны - уравновешенность и готовность работать в команде.";
                levelColor = "#5cb85c";
            } else if (roundedScore >= 60) {
                compatibilityText = "Хороший вариант";
                description = "Этот игрок - неплохой напарник, хотя есть моменты, над которыми можно поработать. В целом, с ним приятно играть, но иногда могут возникать небольшие трения.";
                levelColor = "#ffc107";
            } else if (roundedScore >= 40) {
                compatibilityText = "Можно попробовать";
                description = "Этот игрок неплохо играет, но его поведение в команде иногда может вызывать напряжение. Возможно, ему стоит поработать над коммуникацией и терпимостью к ошибкам.";
                levelColor = "#fd7e14";
            } else {
                compatibilityText = "Проблемный игрок";
                description = "К сожалению, поведение этого игрока в игре может создавать проблемы для команда. Возможно, ему стоит пересмотреть своё отношение к игре и взаимодействию с напарниками.";
                levelColor = "#dc3545";
            }
            
            document.getElementById('compatibility-level').textContent = compatibilityText;
            document.getElementById('compatibility-level').style.color = levelColor;
            document.getElementById('profile-description').textContent = description;
            
            // Генерируем советы по взаимодействию
            generateInteractionTips(scores);
            
            // Отображаем характеристики
            showTraits(scores);
            
            // Отображаем ответы
            showAnswers(answers);
        }
        
        function generateInteractionTips(scores) {
            let tips = [];
            
            if (scores.temperament < 50) {
                tips.push("Этот игрок может эмоционально реагировать на события в игре. Старайтесь не провоцировать его и сохраняйте спокойствие.");
            }
            
            if (scores.tolerance < 50) {
                tips.push("Он может быть нетерпим к ошибкам новичков. Постарайтесь объяснять свои действия, если играете вместе.");
            }
            
            if (scores.communication < 50) {
                if (scores.communication < 30) {
                    tips.push("Он редко общается в чате. Пробуйте инициировать обсуждение тактики, но не настаивайте слишком сильно.");
                } else {
                    tips.push("Обращайте внимание на тон его сообщений, они могут звучать как критика.");
                }
            }
            
            if (scores.teamSpirit < 50) {
                tips.push("Он может предпочитать личные достижения командным. Постарайтесь найти баланс в совместной игре.");
            }
            
            if (scores.humor < 50) {
                tips.push("Он может серьезно относиться к игре. Избегайте шуток, которые могут быть восприняты как насмешка.");
            }
            
            if (tips.length === 0) {
                tips.push("Это отличный командный игрок! Наслаждайтесь совместной игрой.");
            }
            
            document.getElementById('interaction-tips').innerHTML = tips.map(tip => `• ${tip}`).join('<br>');
        }
        
        function showTraits(scores) {
            const traitNames = {
                temperament: "Темперамент",
                tolerance: "Толерантность",
                communication: "Коммуникация",
                teamSpirit: "Командный дух",
                learning: "Обучение",
                humor: "Чувство юмора",
                teamRole: "Роль в команде",
                stamina: "Выносливость",
                competitiveness: "Конкурентоспособность",
                strategy: "Стратегия",
                ethics: "Этика",
                focus: "Концентрация",
                flexibility: "Гибкость",
                priority: "Приоритеты"
            };
            
            // Показываем только основные характеристики
            const mainTraits = ['temperament', 'tolerance', 'communication', 'teamSpirit', 'humor', 'focus'];
            const traitsContainer = document.getElementById('traits-container');
            traitsContainer.innerHTML = '';
            
            mainTraits.forEach(trait => {
                if (scores[trait] === undefined) return;
                
                const traitDiv = document.createElement('div');
                traitDiv.className = 'trait';
                
                const nameSpan = document.createElement('div');
                nameSpan.className = 'trait-name';
                nameSpan.textContent = traitNames[trait] || trait;
                
                const barDiv = document.createElement('div');
                barDiv.className = 'trait-bar';
                
                const fillDiv = document.createElement('div');
                fillDiv.className = 'trait-fill';
                fillDiv.style.width = `${scores[trait]}%`;
                
                const percentSpan = document.createElement('span');
                percentSpan.className = 'trait-percent';
                percentSpan.textContent = `${scores[trait]}%`;
                
                barDiv.appendChild(fillDiv);
                barDiv.appendChild(percentSpan);
                traitDiv.appendChild(nameSpan);
                traitDiv.appendChild(barDiv);
                
                traitsContainer.appendChild(traitDiv);
            });
        }
        
        function showAnswers(answers) {
            const answersList = document.getElementById('answers-list');
            answersList.innerHTML = '';
            
            questions.forEach((q, index) => {
                if (!answers[index]) return;
                
                const answerIndex = answers[index].optionIndex;
                const answerText = q.options[answerIndex];
                
                const li = document.createElement('li');
                li.innerHTML = `<strong>${q.question}</strong><br>Ответ: ${answerText}`;
                answersList.appendChild(li);
            });
        }
        
        // Запускаем загрузку при открытии страницы
        document.addEventListener('DOMContentLoaded', checkAndLoadResults);
    </script>
</body>
</html>